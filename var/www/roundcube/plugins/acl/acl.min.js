window.rcmail&&rcmail.addEventListener("init",function(){rcmail.gui_objects.acltable&&(rcmail.acl_list_init(),rcmail.env.acl_users_source&&(rcmail.init_address_input_events($("#acluser"),{action:"settings/plugin.acl-autocomplete"}),rcmail.addEventListener("autocomplete_insert",function(a){if("acluser"==a.field.id){var b=a.insert;b.match(/\s*\(([^)]+)\)[, ]*$/)&&(b=RegExp.$1);a.field.value=b}})));rcmail.enable_command("acl-create","acl-save","acl-cancel","acl-mode-switch",!0);rcmail.enable_command("acl-delete",
"acl-edit",!1);rcmail.env.acl_advanced&&$("#acl-switch").addClass("selected")});rcube_webmail.prototype.acl_create=function(){this.acl_init_form()};rcube_webmail.prototype.acl_edit=function(){var a=this.acl_list.get_single_selection();a&&this.acl_init_form(a)};
rcube_webmail.prototype.acl_delete=function(){var a=this.acl_get_usernames();a&&a.length&&confirm(this.get_label("acl.deleteconfirm"))&&this.http_request("settings/plugin.acl","_act=delete&_user="+urlencode(a.join(","))+"&_mbox="+urlencode(this.env.mailbox),this.set_busy(!0,"acl.deleting"))};
rcube_webmail.prototype.acl_save=function(){var a=$("#acluser").val(),b="",c;$(":checkbox",this.env.acl_advanced?$("#advancedrights"):sim_ul=$("#simplerights")).map(function(){this.checked&&(b+=this.value)});(c=$("input:checked[name=usertype]").val())&&"user"!=c&&(a=c);a?b?this.http_request("settings/plugin.acl","_act=save&_user="+urlencode(a)+"&_acl="+b+"&_mbox="+urlencode(this.env.mailbox)+(this.acl_id?"&_old="+this.acl_id:""),this.set_busy(!0,"acl.saving")):alert(this.get_label("acl.norights")):
alert(this.get_label("acl.nouser"))};rcube_webmail.prototype.acl_cancel=function(){this.ksearch_blur();this.acl_form.hide()};rcube_webmail.prototype.acl_update=function(a){a.old?this.acl_remove_row(a.old):this.env.acl[a.id]&&this.acl_remove_row(a.id);this.acl_add_row(a,!0);this.ksearch_blur();this.acl_form.hide()};
rcube_webmail.prototype.acl_mode_switch=function(a){this.env.acl_advanced=!this.env.acl_advanced;this.enable_command("acl-delete","acl-edit",!1);this.http_request("settings/plugin.acl","_act=list&_mode="+(this.env.acl_advanced?"advanced":"simple")+"&_mbox="+urlencode(this.env.mailbox),this.set_busy(!0,"loading"))};
rcube_webmail.prototype.acl_list_init=function(){$("#acl-switch")[this.env.acl_advanced?"addClass":"removeClass"]("selected");this.acl_list=new rcube_list_widget(this.gui_objects.acltable,{multiselect:!0,draggable:!1,keyboard:!0,toggleselect:!0});this.acl_list.addEventListener("select",function(a){rcmail.acl_list_select(a)});this.acl_list.addEventListener("dblclick",function(a){rcmail.acl_list_dblclick(a)});this.acl_list.addEventListener("keypress",function(a){rcmail.acl_list_keypress(a)});this.acl_list.init()};
rcube_webmail.prototype.acl_list_select=function(a){rcmail.enable_command("acl-delete",0<a.selection.length);rcmail.enable_command("acl-edit",1==a.selection.length);a.focus()};rcube_webmail.prototype.acl_list_dblclick=function(a){this.acl_edit()};rcube_webmail.prototype.acl_list_keypress=function(a){if(a.key_pressed==a.ENTER_KEY)this.command("acl-edit");else if(a.key_pressed==a.DELETE_KEY||a.key_pressed==a.BACKSPACE_KEY)this.acl_form&&this.acl_form.is(":visible")||this.command("acl-delete")};
rcube_webmail.prototype.acl_list_update=function(a){$(this.gui_objects.acltable).html(a);this.acl_list_init()};rcube_webmail.prototype.acl_get_usernames=function(){var a=[],b,c,d,e=this.acl_list,f=e.get_selection();b=0;for(c=f.length;b<c;b++)if(this.env.acl_specials.length&&0<=$.inArray(f[b],this.env.acl_specials))a.push(f[b]);else if(d=e.rows[f[b]])d=$("td.user",d.obj),1==d.length&&a.push(d.text());return a};
rcube_webmail.prototype.acl_remove_row=function(a){var b=this.acl_list;b.remove_row(a);b.clear_selection();$("#rcmrow"+a).remove();this.env.acl[a]=null;this.enable_command("acl-delete",0<b.selection.length);this.enable_command("acl-edit",1==b.selection.length)};
rcube_webmail.prototype.acl_add_row=function(a,b){var c,d,e=[];d=[];var f=a.id,h=this.acl_list,k=this.env.acl_advanced?[]:this.env.acl_items,g=$("thead > tr",this.gui_objects.acltable).clone();$("td",g).map(function(){var b=this.className.replace(/^acl/,"");k&&k[b]&&(b=k[b]);"user"==b?$(this).text(a.username):$(this).addClass(rcmail.acl_class(a.acl,b)).text("")});g.attr("id","rcmrow"+f);g=g.get(0);this.env.acl[f]=a.acl;for(c in this.env.acl)this.env.acl[c]&&(this.env.acl_specials.length&&0<=$.inArray(c,
this.env.acl_specials)?d.push(c):e.push(c));e.sort();e=d.concat(e);c=0;for(d=e.length;c<d&&e[c]!=f;c++);c&&c<d?($("#rcmrow"+e[c-1]).after(g),h.init_row(g),h.rowcount++):h.insert_row(g);b&&h.select_row(a.id)};
rcube_webmail.prototype.acl_init_form=function(a){var b,c,d,e="",f="user",h=$("body");b=$("#advancedrights");var k=$("#simplerights"),g=$("#acluser");if(!this.acl_form){var l=function(){$("input[value=user]").prop("checked",!0)};g.click(l).keypress(l)}this.acl_form=$("#aclform");this.env.acl_advanced?(b.show(),k.hide()):(k.show(),b.hide(),b=k);b=$(":checkbox",b);b.attr("checked",!1);a&&(c=this.acl_list.rows[a])?(c=c.obj,b.map(function(){e=this.value;d=$("td."+this.id,c);d.length&&d.hasClass("enabled")&&
(this.checked=!0)}),!this.env.acl_specials.length||0>$.inArray(a,this.env.acl_specials)?e=$("td.user",c).text():f=a):b.filter(function(){return this.id.match(/^acl([lrs]|read)$/)}).prop("checked",!0);g.val(e);$("input[value="+f+"]").prop("checked",!0);this.acl_id=a;a=h.width();h=this.acl_form.width();a>=h&&this.acl_form.css({left:parseInt((a-h)/2)+"px"});this.acl_form.show();"user"==f&&g.focus();this.acl_list.blur()};
rcube_webmail.prototype.acl_class=function(a,b){var c,d,e=0;a=String(a);b=String(b);c=0;for(d=b.length;c<d;c++)-1<a.indexOf(b[c])&&e++;return e==d?"enabled":e?"partial":"disabled"};
